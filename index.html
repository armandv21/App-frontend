<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Optimiseur de Portefeuille — Markowitz</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.27.0/plotly.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg:#f4f1eb;--surface:#faf8f4;--surface2:#ede9e1;--surface3:#e4dfd5;
  --border:#d4cfc5;--border2:#c4bdb0;--ink:#1a1714;--ink2:#3d3830;
  --muted:#8a8278;--muted2:#b0a99f;--blue:#1e3a5f;--blue-lt:#3466a0;
  --teal:#1a5c52;--teal-lt:#2d8a7a;--amber:#8a5a00;--amber-lt:#c4820a;
  --rose:#7a1f2e;--rose-lt:#b03045;
  --font-serif:'Libre Baskerville',Georgia,serif;
  --font-sans:'DM Sans',system-ui,sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--ink);font-family:var(--font-sans);font-size:14px;min-height:100vh;overflow-x:hidden;}
.app{display:flex;height:100vh;overflow:hidden;}
.sidebar{width:280px;min-width:280px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.sidebar-header{padding:28px 22px 18px;border-bottom:1px solid var(--border);}
.sidebar-title{font-family:var(--font-sans);font-size:1.55rem;line-height:1.2;background:linear-gradient(135deg,#1e3a5f 0%,#3466a0 50%,#1a5c52 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:700;}
.sidebar-body{flex:1;overflow-y:auto;padding:16px 20px;}
.sidebar-body::-webkit-scrollbar{width:3px;}
.sidebar-body::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.section-label{font-size:0.62rem;font-weight:600;letter-spacing:0.14em;color:var(--muted);text-transform:uppercase;margin:18px 0 8px;padding-bottom:5px;border-bottom:1px solid var(--border);}
.asset-category{margin-bottom:3px;}
.category-toggle{display:flex;align-items:center;gap:8px;padding:7px 10px;background:none;border:1px solid transparent;border-radius:5px;cursor:pointer;font-family:var(--font-sans);font-size:0.8rem;font-weight:500;color:var(--ink2);width:100%;transition:all 0.15s;text-align:left;}
.category-toggle:hover{background:var(--surface2);border-color:var(--border);}
.category-arrow{margin-left:auto;transition:transform 0.2s;font-size:0.55rem;color:var(--muted2);}
.category-toggle.open{background:var(--surface2);}
.category-toggle.open .category-arrow{transform:rotate(90deg);}
.category-items{display:none;padding:3px 0 3px 6px;}
.category-items.open{display:block;}
.asset-item{display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:4px;cursor:pointer;transition:background 0.12s;font-size:0.78rem;color:var(--ink2);}
.asset-item:hover{background:var(--surface2);}
.asset-item input[type=checkbox]{accent-color:var(--blue);width:13px;height:13px;cursor:pointer;flex-shrink:0;}
.asset-item.selected{color:var(--blue);font-weight:500;}
.asset-item .ticker-tag{color:var(--muted2);font-size:0.65rem;margin-left:auto;}
.selected-count{font-size:0.72rem;color:var(--muted);margin-top:6px;}
.selected-count span{color:var(--blue);font-weight:600;}
.param-row{margin-bottom:14px;}
.param-label{display:flex;justify-content:space-between;align-items:center;font-size:0.75rem;color:var(--muted);margin-bottom:7px;}
.param-label strong{color:var(--ink2);font-weight:600;}
input[type=range]{width:100%;height:2px;background:var(--border2);border-radius:2px;outline:none;cursor:pointer;appearance:none;}
input[type=range]::-webkit-slider-thumb{appearance:none;width:13px;height:13px;border-radius:50%;background:var(--blue);border:2px solid var(--surface);cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,0.15);}
.sidebar-footer{padding:16px 20px;border-top:1px solid var(--border);}
.btn-run{width:100%;padding:11px 16px;background:var(--blue);border:none;border-radius:6px;color:white;font-family:var(--font-sans);font-size:0.78rem;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;cursor:pointer;transition:all 0.18s;}
.btn-run:hover{background:var(--blue-lt);}
.btn-run:disabled{opacity:0.4;cursor:not-allowed;}
.main{flex:1;overflow-y:auto;display:flex;flex-direction:column;background:var(--bg);}
.main::-webkit-scrollbar{width:4px;}
.main::-webkit-scrollbar-thumb{background:var(--border);}
.topbar{padding:0 32px;display:flex;align-items:flex-end;gap:2px;border-bottom:1px solid var(--border);background:var(--surface);}
.tab-btn{padding:14px 18px 12px;background:none;border:none;font-family:var(--font-sans);font-size:0.75rem;font-weight:500;letter-spacing:0.04em;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.18s;white-space:nowrap;}
.tab-btn:hover{color:var(--ink);}
.tab-btn.active{color:var(--blue);border-bottom-color:var(--blue);font-weight:600;}
.content{flex:1;padding:28px 32px;}
.kpi-bar{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px;}
.kpi-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px 16px;border-left:3px solid var(--border2);}
.kpi-card.blue{border-left-color:var(--blue);}
.kpi-card.amber{border-left-color:var(--amber-lt);}
.kpi-card.teal{border-left-color:var(--teal-lt);}
.kpi-card.rose{border-left-color:var(--rose-lt);}
.kpi-label{font-size:0.65rem;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.kpi-value{font-family:var(--font-serif);font-size:1.4rem;font-weight:700;}
.kpi-value.blue{color:var(--blue);}
.kpi-value.amber{color:var(--amber);}
.kpi-value.teal{color:var(--teal);}
.kpi-value.rose{color:var(--rose);}
.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:24px;}
.chart-header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.chart-title{font-family:var(--font-serif);font-size:0.95rem;font-weight:700;color:var(--ink);}
.chart-subtitle{font-size:0.7rem;color:var(--muted);margin-left:auto;font-style:italic;}
.chart-with-legend{display:flex;align-items:stretch;}
.chart-area{flex:1;min-width:0;}
.chart-legend{width:190px;min-width:190px;border-left:1px solid var(--border);padding:16px 14px;display:flex;flex-direction:column;gap:9px;background:var(--surface2);}
.legend-title{font-size:0.62rem;font-weight:600;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);padding-bottom:6px;border-bottom:1px solid var(--border);margin-bottom:2px;}
.legend-item{display:flex;align-items:center;gap:8px;font-size:0.75rem;color:var(--ink2);line-height:1.3;}
.legend-line{width:22px;height:2.5px;border-radius:2px;flex-shrink:0;}
.legend-line-dashed{width:22px;height:0;border-top:2px dashed currentColor;flex-shrink:0;}
.cml-controls{padding:14px 20px;border-bottom:1px solid var(--border);background:var(--surface2);}
.cml-instruction{font-size:0.72rem;color:var(--muted);margin-bottom:12px;font-style:italic;}
.cml-mix-bar{display:flex;height:5px;border-radius:3px;overflow:hidden;margin-bottom:10px;gap:1px;}
.cml-mix-rf{background:var(--teal-lt);transition:width 0.08s;border-radius:3px 0 0 3px;}
.cml-mix-tangent{background:var(--amber-lt);transition:width 0.08s;border-radius:0 3px 3px 0;}
.cml-mix-leverage{background:var(--rose-lt);transition:width 0.08s;border-radius:0 3px 3px 0;}
.cml-mix-labels{display:flex;justify-content:space-between;font-size:0.7rem;color:var(--muted);margin-bottom:12px;flex-wrap:wrap;gap:6px;}
.mix-label-rf{color:var(--teal);}
.mix-label-tangent{color:var(--amber);}
.mix-label-leverage{color:var(--rose);}
.mix-kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.mix-kpi{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:10px 12px;}
.mix-kpi-label{font-size:0.6rem;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.mix-kpi-value{font-family:var(--font-serif);font-size:1.05rem;font-weight:700;}
.cml-stepper{display:flex;flex-direction:column;gap:1px;margin-left:6px;}
.cml-stepper-btn{width:18px;height:14px;background:var(--surface3);border:1px solid var(--border);border-radius:3px;font-size:0.6rem;line-height:1;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--muted);user-select:none;transition:background 0.1s;}
.cml-stepper-btn:hover{background:var(--border);color:var(--ink);}
.cml-stepper-btn:active{background:var(--blue);color:white;border-color:var(--blue);}
.alloc-table{width:100%;border-collapse:collapse;font-size:0.78rem;}
.alloc-table th{font-size:0.62rem;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);padding:8px 12px;border-bottom:1px solid var(--border);text-align:left;}
.alloc-table td{padding:8px 12px;border-bottom:1px solid var(--surface2);}
.alloc-table tr:last-child td{border-bottom:none;}
.alloc-table tr:hover td{background:var(--surface2);}
.alloc-bar-bg{background:var(--surface3);border-radius:2px;height:3px;overflow:hidden;margin-top:2px;}
.alloc-bar-fill{background:var(--amber-lt);height:3px;border-radius:2px;transition:width 0.3s;}
.perf-table{width:100%;border-collapse:collapse;font-size:0.8rem;}
.perf-table th{font-size:0.62rem;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);padding:10px 14px;border-bottom:1px solid var(--border);text-align:right;}
.perf-table th:first-child{text-align:left;}
.perf-table td{padding:9px 14px;border-bottom:1px solid var(--surface2);text-align:right;}
.perf-table td:first-child{text-align:left;}
.perf-table tr:hover td{background:var(--surface2);}
.positive{color:var(--teal);font-weight:500;}
.negative{color:var(--rose);font-weight:500;}
.corr-cell{width:38px;height:38px;display:flex;align-items:center;justify-content:center;font-size:0.6rem;border-radius:3px;}
.corr-table{border-collapse:separate;border-spacing:2px;}
.corr-label{font-size:0.62rem;color:var(--muted);padding:2px 6px;font-weight:500;}
.risk-tabs{display:flex;gap:4px;margin-bottom:20px;flex-wrap:wrap;}
.risk-tab{padding:7px 16px;background:var(--surface);border:1px solid var(--border);border-radius:5px;font-size:0.75rem;font-weight:500;cursor:pointer;transition:all 0.15s;color:var(--ink2);}
.risk-tab:hover{border-color:var(--blue);color:var(--blue);}
.risk-tab.active{background:var(--blue);border-color:var(--blue);color:white;font-weight:600;}
.risk-tab.custom{border-style:dashed;}
.risk-tab.custom.active{background:var(--ink2);border-color:var(--ink2);border-style:solid;}
.custom-inputs{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px;}
.custom-kpi-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px 16px;border-left:3px solid var(--border2);cursor:pointer;transition:all 0.18s;position:relative;}
.custom-kpi-card:hover{border-color:var(--blue-lt);box-shadow:0 2px 8px rgba(30,58,95,0.08);}
.custom-kpi-card.editing{border-left-color:var(--blue);box-shadow:0 0 0 2px rgba(30,58,95,0.15);}
.custom-kpi-card.teal{border-left-color:var(--teal-lt);}
.custom-kpi-card.amber{border-left-color:var(--amber-lt);}
.custom-kpi-card.blue{border-left-color:var(--blue);}
.custom-input-field{width:100%;background:none;border:none;outline:none;font-family:var(--font-serif);font-size:1.2rem;font-weight:700;color:inherit;padding:0;margin:0;cursor:text;}
.custom-input-field::placeholder{color:var(--muted2);font-weight:400;font-style:italic;}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:24px;}
.loading-overlay{position:fixed;inset:0;background:rgba(244,241,235,0.9);display:none;align-items:center;justify-content:center;z-index:100;flex-direction:column;gap:16px;}
.loading-overlay.active{display:flex;}
.spinner{width:34px;height:34px;border:2px solid var(--border2);border-top-color:var(--blue);border-radius:50%;animation:spin 0.85s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.loading-text{font-size:0.72rem;font-weight:500;letter-spacing:0.1em;color:var(--muted);text-transform:uppercase;}
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:400px;gap:10px;color:var(--muted);}
.empty-icon{font-size:2rem;opacity:0.25;}
.empty-title{font-family:var(--font-serif);font-size:1rem;color:var(--ink2);}
.empty-sub{font-size:0.75rem;color:var(--muted);}
.tab-content{display:none;}
.tab-content.active{display:block;}
.risk-tooltip-wrap{position:relative;display:inline-flex;align-items:center;margin-left:5px;vertical-align:middle;}
.risk-help-btn{width:15px;height:15px;border-radius:50%;background:var(--surface3);border:1px solid var(--border2);color:var(--muted);font-size:0.6rem;font-weight:700;display:inline-flex;align-items:center;justify-content:center;cursor:help;line-height:1;flex-shrink:0;font-family:var(--font-sans);}
.risk-tooltip-box{display:none;position:absolute;bottom:calc(100% + 8px);left:0;background:var(--ink);color:#f4f1eb;border-radius:8px;padding:12px 14px;width:260px;font-size:0.72rem;line-height:1.55;font-family:var(--font-sans);font-weight:400;box-shadow:0 4px 20px rgba(0,0,0,0.2);z-index:200;pointer-events:none;}
.risk-tooltip-box::after{content:'';position:absolute;top:100%;left:8px;border:6px solid transparent;border-top-color:var(--ink);}
.risk-tooltip-box strong{display:block;margin-bottom:5px;font-size:0.75rem;color:#e4dfd5;}
.risk-tooltip-box .tooltip-math{font-size:0.67rem;color:#b0a99f;margin-top:6px;padding-top:6px;border-top:1px solid rgba(255,255,255,0.1);font-style:italic;}
.risk-tooltip-wrap:hover .risk-tooltip-box,.risk-tooltip-wrap:focus-within .risk-tooltip-box{display:block;}
#etfEquivBtn:hover{border-color:var(--blue);color:var(--blue);background:rgba(30,58,95,0.04);}
.etf-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px 16px;}
.etf-card-header{font-size:0.65rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}
.etf-metric{font-size:0.72rem;color:var(--muted2);}
.etf-match-bar{height:5px;border-radius:3px;background:var(--border);margin-top:6px;}
.etf-match-fill{height:5px;border-radius:3px;}
.etf-loading{text-align:center;padding:24px;color:var(--muted);font-size:0.8rem;font-style:italic;}
.contact-btn{margin-left:auto;padding:8px 16px;background:none;border:1px solid var(--border);border-radius:5px;font-family:var(--font-sans);font-size:0.72rem;font-weight:500;color:var(--muted);cursor:pointer;transition:all 0.18s;white-space:nowrap;align-self:center;margin-bottom:6px;}
.contact-btn:hover{border-color:var(--blue);color:var(--blue);}
.popup-overlay{position:fixed;inset:0;background:rgba(26,23,20,0.35);display:none;align-items:center;justify-content:center;z-index:300;backdrop-filter:blur(2px);}
.popup-overlay.active{display:flex;}
.popup-box{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:32px 36px;max-width:360px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.12);position:relative;}
.popup-close{position:absolute;top:14px;right:16px;background:none;border:none;font-size:1.1rem;color:var(--muted);cursor:pointer;line-height:1;}
.popup-close:hover{color:var(--ink);}
.popup-title{font-family:var(--font-serif);font-size:1rem;font-weight:700;margin-bottom:10px;color:var(--ink);}
.popup-label{font-size:0.72rem;color:var(--muted);margin-bottom:8px;}
.popup-mail{display:inline-block;font-size:0.88rem;font-weight:600;color:var(--blue);text-decoration:none;border-bottom:1px solid var(--border);padding-bottom:2px;}
.popup-mail:hover{border-color:var(--blue);}
.search-wrap{position:relative;margin-bottom:6px;}
.search-input{width:100%;padding:7px 30px 7px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:5px;font-family:var(--font-sans);font-size:0.78rem;color:var(--ink);outline:none;transition:border-color 0.15s;}
.search-input:focus{border-color:var(--blue-lt);background:var(--surface);}
.search-input::placeholder{color:var(--muted2);}
.search-clear{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted2);cursor:pointer;font-size:0.75rem;display:none;line-height:1;}
.search-clear.visible{display:block;}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Chargement des données…</div>
</div>

<div class="app">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">Optimiseur de Portefeuille</div>
    </div>
    <div class="sidebar-body">
      <div class="section-label">Sélection des actifs</div>
      <div class="search-wrap">
        <input class="search-input" id="assetSearch" type="text" placeholder="Rechercher un actif…" oninput="filterAssets(this.value)"/>
        <button class="search-clear" id="searchClear" onclick="clearSearch()">✕</button>
      </div>
      <div class="selected-count" style="display:flex;align-items:center;justify-content:space-between;">
        <span>Sélectionnés : <span id="selectedCount">0</span> actifs</span>
        <button onclick="resetSelection()" title="Tout désélectionner" style="background:none;border:none;font-size:0.68rem;color:var(--blue);cursor:pointer;line-height:1.6;text-decoration:underline;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">Réinitialiser</button>
      </div>
      <div id="assetList"></div>
      <div class="section-label">Paramètres</div>
      <div class="param-row">
        <div class="param-label">Période historique <strong id="periodVal">2 ans</strong></div>
        <input type="range" id="periodRange" min="1" max="5" value="2" step="1"/>
      </div>
      <div class="param-row">
        <div class="param-label">Taux sans risque <strong id="rfVal">3,0 %</strong></div>
        <input type="range" id="rfRange" min="0" max="10" value="3" step="0.1"/>
      </div>
      <div class="param-row">
        <div class="param-label">Simulations Monte Carlo <strong id="simVal">6 000</strong></div>
        <input type="range" id="simRange" min="1000" max="15000" value="6000" step="500"/>
      </div>
    </div>
    <div class="sidebar-footer">
      <button class="btn-run" id="btnRun" onclick="runOptimization()">Calculer</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <button class="tab-btn active" onclick="switchTab('frontier',this)">Frontière efficiente</button>
      <button class="tab-btn" onclick="switchTab('cml',this)">CML interactive</button>
      <button class="tab-btn" onclick="switchTab('risk',this)">Niveaux de risque</button>
      <button class="tab-btn" onclick="switchTab('perf',this)">Performances</button>
      <button class="contact-btn" onclick="openContact()">Contact</button>
    </div>
    <div class="content">
      <div class="kpi-bar" id="kpiBar" style="display:none">
        <div class="kpi-card blue"><div class="kpi-label">Rendement — Tangent</div><div class="kpi-value blue" id="kpiRet">—</div></div>
        <div class="kpi-card amber"><div class="kpi-label">Volatilité — Tangent</div><div class="kpi-value amber" id="kpiVol">—</div></div>
        <div class="kpi-card teal"><div class="kpi-label">Ratio de Sharpe max.</div><div class="kpi-value teal" id="kpiSharpe">—</div></div>
        <div class="kpi-card rose"><div class="kpi-label">Actifs analysés</div><div class="kpi-value rose" id="kpiAssets">—</div></div>
      </div>
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">◈</div>
        <div class="empty-title">Aucun portefeuille calculé</div>
        <div class="empty-sub">Sélectionnez au moins 2 actifs, puis cliquez sur « Calculer »</div>
      </div>

      <div class="tab-content active" id="tab-frontier">
        <div class="chart-card" id="frontierCard" style="display:none">
          <div class="chart-header">
            <span class="chart-title">Frontière efficiente de Markowitz</span>
            <span class="chart-subtitle">Simulation Monte Carlo</span>
          </div>
          <div class="chart-with-legend">
            <div class="chart-area"><div id="frontierChart" style="height:500px;"></div></div>
            <div class="chart-legend" id="frontierLegend"><div class="legend-title">Légende</div></div>
          </div>
        </div>
      </div>

      <div class="tab-content" id="tab-cml">
        <div class="chart-card" id="cmlCard" style="display:none">
          <div class="chart-header">
            <span class="chart-title">Capital Market Line</span>
            <span class="chart-subtitle">Point déplaçable</span>
          </div>
          <div class="cml-controls">
            <div class="cml-instruction">Cliquez et glissez le point sur le graphique pour ajuster votre exposition.</div>
            <div class="cml-mix-bar">
              <div class="cml-mix-rf" id="mixBarRf" style="width:0%"></div>
              <div class="cml-mix-tangent" id="mixBarTangent" style="width:100%"></div>
              <div class="cml-mix-leverage" id="mixBarLev" style="width:0%;display:none"></div>
            </div>
            <div class="cml-mix-labels">
              <span class="mix-label-rf">Cash : <strong id="mixRfPct">0 %</strong></span>
              <span class="mix-label-tangent">Portefeuille tangent : <strong id="mixTangentPct">100 %</strong></span>
              <span class="mix-label-leverage" id="leverageLabel" style="display:none">Levier : <strong id="mixLeveragePct">0 %</strong></span>
            </div>
            <div class="mix-kpis">
              <div class="mix-kpi">
                <div class="mix-kpi-label">Rendement</div>
                <div style="display:flex;align-items:center;gap:4px;margin-top:2px">
                  <span class="mix-kpi-value" id="mixRetInp" style="color:var(--teal);min-width:52px">—</span>
                  <span style="font-size:0.78rem;color:var(--teal)">%</span>
                  <div class="cml-stepper">
                    <button class="cml-stepper-btn" onmousedown="startCMLStep('ret',+0.1)" onmouseup="stopCMLStep()" onmouseleave="stopCMLStep()" ontouchstart="startCMLStep('ret',+0.1)" ontouchend="stopCMLStep()">▲</button>
                    <button class="cml-stepper-btn" onmousedown="startCMLStep('ret',-0.1)" onmouseup="stopCMLStep()" onmouseleave="stopCMLStep()" ontouchstart="startCMLStep('ret',-0.1)" ontouchend="stopCMLStep()">▼</button>
                  </div>
                </div>
              </div>
              <div class="mix-kpi">
                <div class="mix-kpi-label">Volatilité</div>
                <div style="display:flex;align-items:center;gap:4px;margin-top:2px">
                  <span class="mix-kpi-value" id="mixVolInp" style="color:var(--amber);min-width:52px">—</span>
                  <span style="font-size:0.78rem;color:var(--amber)">%</span>
                  <div class="cml-stepper">
                    <button class="cml-stepper-btn" onmousedown="startCMLStep('vol',+0.1)" onmouseup="stopCMLStep()" onmouseleave="stopCMLStep()" ontouchstart="startCMLStep('vol',+0.1)" ontouchend="stopCMLStep()">▲</button>
                    <button class="cml-stepper-btn" onmousedown="startCMLStep('vol',-0.1)" onmouseup="stopCMLStep()" onmouseleave="stopCMLStep()" ontouchstart="startCMLStep('vol',-0.1)" ontouchend="stopCMLStep()">▼</button>
                  </div>
                </div>
              </div>
              <div class="mix-kpi">
                <div class="mix-kpi-label">Sharpe</div>
                <div class="mix-kpi-value" id="mixSharpe" style="color:var(--blue)">—</div>
              </div>
            </div>
          </div>
          <div class="chart-with-legend">
            <div class="chart-area"><div id="cmlChart" style="height:440px;"></div></div>
            <div class="chart-legend" id="cmlLegend"><div class="legend-title">Légende</div></div>
          </div>
          <div style="padding:18px 20px;border-top:1px solid var(--border);">
            <div style="font-size:0.65rem;font-weight:600;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);margin-bottom:14px">Composition du portefeuille total</div>
            <div class="two-col">
              <div id="cmlAllocTable"></div>
              <div id="cmlPieChart" style="height:260px;"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content" id="tab-risk">
        <div id="riskCard" style="display:none">
          <div class="risk-tabs" id="riskTabs"></div>
          <div class="two-col" id="riskContent"></div>
          <div style="margin-top:18px;text-align:center">
            <button id="etfEquivBtn" onclick="computeETFEquivalent()"
              style="font-family:var(--font-sans);font-size:0.78rem;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;background:none;border:1.5px dashed var(--border2);border-radius:6px;padding:9px 22px;cursor:pointer;color:var(--ink2);transition:all 0.15s">
              Composition ETF équivalent
            </button>
          </div>
          <div id="etfEquivResult" style="margin-top:18px;display:none"></div>
        </div>
      </div>

      <div class="tab-content" id="tab-perf">
        <div class="chart-card" id="perfCard" style="display:none">
          <div class="chart-header"><span class="chart-title">Performances individuelles</span></div>
          <div style="overflow-x:auto;padding:4px 0;"><table class="perf-table" id="perfTable"></table></div>
        </div>
        <div class="chart-card" id="corrCard" style="display:none;margin-top:16px;">
          <div class="chart-header"><span class="chart-title">Matrice de corrélation</span></div>
          <div style="overflow-x:auto;padding:14px;"><div id="corrMatrix"></div></div>
        </div>
      </div>
    </div>
  </main>
</div>

<div class="popup-overlay" id="contactPopup" onclick="if(event.target===this)closeContact()">
  <div class="popup-box">
    <button class="popup-close" onclick="closeContact()">✕</button>
    <div class="popup-title">Contact</div>
    <div class="popup-label">Pour toute question ou suggestion :</div>
    <div id="contactMailTarget"></div>
  </div>
</div>

<script>
// ── Config ────────────────────────────────────────────────────────────────────
// Remplacez cette URL par l'URL de votre backend Render après déploiement
const API_URL = 'https://app-backend-k9i5.onrender.com';

// ── Asset list ────────────────────────────────────────────────────────────────
const ASSETS = {
  "Actions américaines": {
    "Apple":"AAPL","Microsoft":"MSFT","Amazon":"AMZN","Alphabet":"GOOGL","NVIDIA":"NVDA",
    "Meta":"META","Tesla":"TSLA","Berkshire B":"BRK-B","JPMorgan":"JPM","Johnson & Johnson":"JNJ",
    "ExxonMobil":"XOM","Visa":"V","UnitedHealth":"UNH","Procter & Gamble":"PG","Mastercard":"MA",
    "Home Depot":"HD","Chevron":"CVX","Coca-Cola":"KO","PepsiCo":"PEP","AbbVie":"ABBV"
  },
  "CAC 40": {
    "LVMH":"MC.PA","TotalEnergies":"TTE.PA","Hermès":"RMS.PA","Airbus":"AIR.PA",
    "Schneider Electric":"SU.PA","BNP Paribas":"BNP.PA","Sanofi":"SAN.PA","L'Oréal":"OR.PA",
    "Kering":"KER.PA","Danone":"BN.PA","Vinci":"DG.PA"
  },
  "Actions internationales": {
    "Toyota":"TM","ASML":"ASML","Nestlé":"NSRGY","Novo Nordisk":"NVO","HSBC":"HSBC",
    "Shell":"SHEL","AstraZeneca":"AZN","SAP":"SAP","Siemens":"SIEGY","Sony":"SONY","Nintendo":"NTDOY"
  },
  "ETF": {
    "S&P 500 (SPY)":"SPY","Nasdaq (QQQ)":"QQQ","MSCI World (URTH)":"URTH","Total Market (VTI)":"VTI",
    "Marchés émergents (IEMG)":"IEMG","Europe (IEV)":"IEV","Dividendes (VIG)":"VIG",
    "Innovation (ARKK)":"ARKK","Japon (EWJ)":"EWJ","Robotique (BOTZ)":"BOTZ",
    "Or (IAU)":"IAU","Immobilier (VNQ)":"VNQ","Obligations 20 ans (TLT)":"TLT",
    "Obligations corp. (LQD)":"LQD","Santé (XLV)":"XLV","Technologie (XLK)":"XLK",
    "Énergie (XLE)":"XLE","Énergie propre (ICLN)":"ICLN"
  }
};

let appState = { selected: new Set(), rf: 0.03, period: '2y', nSim: 6000, results: null, cmlExposure: 1.0 };

// ── Sidebar ───────────────────────────────────────────────────────────────────
function buildSidebar() {
  const container = document.getElementById('assetList');
  for (const [cat, assets] of Object.entries(ASSETS)) {
    const catDiv = document.createElement('div'); catDiv.className = 'asset-category';
    const toggle = document.createElement('button'); toggle.className = 'category-toggle';
    toggle.innerHTML = `<span>${cat}</span><span class="category-arrow">▶</span>`;
    toggle.onclick = () => {
      toggle.classList.toggle('open');
      itemsDiv.classList.toggle('open');
    };
    const itemsDiv = document.createElement('div'); itemsDiv.className = 'category-items';
    for (const [name, ticker] of Object.entries(assets)) {
      const item = document.createElement('label'); item.className = 'asset-item';
      const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = ticker;
      cb.onchange = () => toggleAsset(ticker, cb.checked, item);
      item.appendChild(cb);
      item.appendChild(document.createTextNode(name));
      const tag = document.createElement('span'); tag.className = 'ticker-tag'; tag.textContent = ticker;
      item.appendChild(tag);
      itemsDiv.appendChild(item);
    }
    catDiv.appendChild(toggle); catDiv.appendChild(itemsDiv);
    container.appendChild(catDiv);
  }
}

function toggleAsset(ticker, checked, item) {
  if (checked) { appState.selected.add(ticker); item.classList.add('selected'); }
  else { appState.selected.delete(ticker); item.classList.remove('selected'); }
  document.getElementById('selectedCount').textContent = appState.selected.size;
}

function resetSelection() {
  appState.selected.clear();
  document.querySelectorAll('.asset-item').forEach(el => {
    el.classList.remove('selected');
    const cb = el.querySelector('input[type="checkbox"]');
    if (cb) cb.checked = false;
  });
  document.getElementById('selectedCount').textContent = 0;
}

function filterAssets(query) {
  const q = query.trim().toLowerCase();
  document.getElementById('searchClear').classList.toggle('visible', q.length > 0);
  document.querySelectorAll('.asset-category').forEach(cat => {
    const items = cat.querySelectorAll('.asset-item');
    const toggle = cat.querySelector('.category-toggle');
    const itemsDiv = cat.querySelector('.category-items');
    if (!q) {
      items.forEach(item => item.style.display = '');
      cat.style.display = '';
      if (!cat._wasOpen) { toggle.classList.remove('open'); itemsDiv.classList.remove('open'); }
      delete cat._wasOpen;
    } else {
      if (cat._wasOpen === undefined) cat._wasOpen = toggle.classList.contains('open');
      let anyVisible = false;
      items.forEach(item => {
        const match = item.textContent.toLowerCase().includes(q);
        item.style.display = match ? '' : 'none';
        if (match) anyVisible = true;
      });
      cat.style.display = anyVisible ? '' : 'none';
      if (anyVisible) { toggle.classList.add('open'); itemsDiv.classList.add('open'); }
      else { toggle.classList.remove('open'); itemsDiv.classList.remove('open'); }
    }
  });
}
function clearSearch() { const i=document.getElementById('assetSearch'); i.value=''; filterAssets(''); i.focus(); }

// ── Sliders ───────────────────────────────────────────────────────────────────
const PERIODS = {1:'1y',2:'2y',3:'3y',5:'5y'};
const PERIOD_LABELS = {1:'1 an',2:'2 ans',3:'3 ans',5:'5 ans'};
document.getElementById('periodRange').oninput = function() {
  appState.period = PERIODS[this.value] || '2y';
  document.getElementById('periodVal').textContent = PERIOD_LABELS[this.value] || '2 ans';
};
document.getElementById('rfRange').oninput = function() {
  appState.rf = this.value / 100;
  document.getElementById('rfVal').textContent = parseFloat(this.value).toFixed(1).replace('.', ',') + ' %';
};
document.getElementById('simRange').oninput = function() {
  appState.nSim = parseInt(this.value);
  document.getElementById('simVal').textContent = parseInt(this.value).toLocaleString('fr-FR');
};

// ── Tabs ──────────────────────────────────────────────────────────────────────
function switchTab(name, btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
}

function setLoading(txt) { document.getElementById('loadingText').textContent = txt; }

// ── Main API call ─────────────────────────────────────────────────────────────
async function runOptimization() {
  const tickers = [...appState.selected];
  if (tickers.length < 2) { alert('Sélectionnez au moins 2 actifs.'); return; }

  document.getElementById('loadingOverlay').classList.add('active');
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('btnRun').disabled = true;
  setLoading('Envoi de la requête au serveur…');

  const fetchWithRetry = async (url, options, retries = 5) => {
    for (let i = 0; i < retries; i++) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 300000);
        const resp = await fetch(url, { ...options, signal: controller.signal });
        clearTimeout(timeoutId);
        return resp;
      } catch (err) {
        if (i === retries - 1) throw err;
        setLoading(`Serveur en démarrage, nouvelle tentative (${i + 2}/${retries})…`);
        await new Promise(r => setTimeout(r, 8000));
      }
    }
  };

  try {
    const resp = await fetchWithRetry(`${API_URL}/optimize`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        tickers,
        period: appState.period,
        rf: appState.rf,
        nSim: appState.nSim,
      })
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({ detail: resp.statusText }));
      throw new Error(err.detail || 'Erreur serveur');
    }

    setLoading('Traitement des résultats…');
    const data = await resp.json();

    // Build allNames from available tickers
    data.allNames = data.available.map(t => {
      for (const [, assets] of Object.entries(ASSETS))
        for (const [name, ticker] of Object.entries(assets))
          if (ticker === t) return name;
      return t;
    });

    appState.results = data;
    appState.cmlExposure = 1.0;
    renderAll();
  } catch(e) {
    console.error(e);
    alert('Erreur : ' + e.message);
  } finally {
    document.getElementById('loadingOverlay').classList.remove('active');
    document.getElementById('btnRun').disabled = false;
  }
}

// ── Plot helpers ──────────────────────────────────────────────────────────────
const TOOLBAR = {
  responsive:true, displayModeBar:true, displaylogo:false,
  modeBarButtonsToRemove:['select2d','lasso2d','hoverClosestCartesian','hoverCompareCartesian','toggleSpikelines','sendDataToCloud','toImage'],
};
function plotLayout() {
  return {
    paper_bgcolor:'transparent', plot_bgcolor:'#faf8f4',
    font:{color:'#3d3830',family:'DM Sans, sans-serif',size:11},
    xaxis:{title:{text:'Volatilité annualisée (%)',font:{size:11,color:'#8a8278'},standoff:12},gridcolor:'#e4dfd5',gridwidth:1,zeroline:false,tickfont:{size:10,color:'#8a8278'},linecolor:'#d4cfc5',linewidth:1,mirror:true},
    yaxis:{title:{text:'Rendement annualisé (%)',font:{size:11,color:'#8a8278'},standoff:12},gridcolor:'#e4dfd5',gridwidth:1,zeroline:false,tickfont:{size:10,color:'#8a8278'},linecolor:'#d4cfc5',linewidth:1,mirror:true},
    showlegend:false,
    hoverlabel:{bgcolor:'#faf8f4',bordercolor:'#1e3a5f',font:{size:11,color:'#1a1714',family:'DM Sans, sans-serif'}},
    margin:{l:60,r:20,t:20,b:60},
    dragmode:'zoom',
  };
}

// ── Client-side helpers (no algo — only display) ──────────────────────────────
function portfolioStatsLocal(weights, meanRets, covMatrix, rf) {
  const n = weights.length;
  let ret = 0; for(let i=0;i<n;i++) ret += weights[i]*meanRets[i]; ret *= 52;
  let variance = 0; for(let i=0;i<n;i++) for(let j=0;j<n;j++) variance += weights[i]*weights[j]*covMatrix[i][j];
  const vol = Math.sqrt(variance*52);
  return {ret, vol, sharpe: vol>0?(ret-rf)/vol:0};
}

// ── Render all ────────────────────────────────────────────────────────────────
function renderAll() {
  const r = appState.results;
  document.getElementById('kpiBar').style.display = 'grid';
  document.getElementById('kpiRet').textContent    = (r.tangent_stats.ret*100).toFixed(2)+' %';
  document.getElementById('kpiVol').textContent    = (r.tangent_stats.vol*100).toFixed(2)+' %';
  document.getElementById('kpiSharpe').textContent = r.tangent_stats.sharpe.toFixed(2);
  document.getElementById('kpiAssets').textContent = r.n;
  renderFrontier(); renderCML(); renderRiskLevels(); renderPerf();
}

function renderFrontier() {
  const r = appState.results;
  document.getElementById('frontierCard').style.display = 'block';
  const mn=Math.min(...r.sim_sharpes), mx=Math.max(...r.sim_sharpes);
  const sharpeNorm = r.sim_sharpes.map(s => (s-mn)/(mx-mn+1e-9));
  const cmlMaxVol = Math.max(...r.sim_vols)*1.15;
  const cmlX = Array.from({length:80},(_,i)=>i/79*cmlMaxVol*100);
  const slope = (r.tangent_stats.ret-appState.rf)/r.tangent_stats.vol;
  const cmlY = cmlX.map(x=>(appState.rf+slope*(x/100))*100);
  const traces=[
    {x:r.sim_vols.map(v=>v*100),y:r.sim_rets.map(v=>v*100),mode:'markers',type:'scatter',
     marker:{size:3.5,opacity:0.45,color:sharpeNorm,colorscale:[['0','#c4bdb0'],['0.5','#3466a0'],['1','#1a5c52']]},
     hovertemplate:'Vol. : %{x:.2f} %<br>Rend. : %{y:.2f} %<extra>Simulation</extra>'},
    {x:r.ef_vols.map(v=>v*100),y:r.ef_rets.map(v=>v*100),mode:'lines',type:'scatter',
     line:{color:'#1e3a5f',width:2.5},
     hovertemplate:'<b>Frontière efficiente</b><br>Vol. : %{x:.2f} %<br>Rend. : %{y:.2f} %<extra></extra>'},
    {x:cmlX,y:cmlY,mode:'lines',type:'scatter',line:{color:'#c4820a',width:1.8,dash:'dot'},
     hovertemplate:'Vol. : %{x:.2f} %<br>Rend. : %{y:.2f} %<extra>CML</extra>'},
    {x:[r.tangent_stats.vol*100],y:[r.tangent_stats.ret*100],mode:'markers',type:'scatter',
     marker:{size:14,color:'#c4820a',symbol:'star',line:{color:'white',width:1.5}},
     hovertemplate:`<b>Portefeuille tangent</b><br>Vol. : ${(r.tangent_stats.vol*100).toFixed(2)} %<br>Rend. : ${(r.tangent_stats.ret*100).toFixed(2)} %<br>Sharpe : ${r.tangent_stats.sharpe.toFixed(2)}<extra></extra>`},
    {x:[r.min_var_stats.vol*100],y:[r.min_var_stats.ret*100],mode:'markers',type:'scatter',
     marker:{size:11,color:'#1a5c52',symbol:'diamond',line:{color:'white',width:1.5}},
     hovertemplate:`<b>Variance minimale</b><br>Vol. : ${(r.min_var_stats.vol*100).toFixed(2)} %<br>Rend. : ${(r.min_var_stats.ret*100).toFixed(2)} %<extra></extra>`},
    {x:[0],y:[appState.rf*100],mode:'markers',type:'scatter',
     marker:{size:9,color:'#7a1f2e',symbol:'circle',line:{color:'white',width:1.5}},
     hovertemplate:`Taux sans risque : ${(appState.rf*100).toFixed(2)} %<extra></extra>`},
  ];
  Plotly.react('frontierChart', traces, plotLayout(), TOOLBAR);
  document.getElementById('frontierLegend').innerHTML=`
    <div class="legend-title">Légende</div>
    <div class="legend-item"><div class="legend-line" style="background:#1e3a5f"></div>Frontière efficiente</div>
    <div class="legend-item"><div class="legend-line-dashed" style="color:#c4820a;width:22px"></div>Capital Market Line</div>
    <div class="legend-item"><span style="color:#c4820a;font-size:14px;line-height:1">★</span>Portefeuille tangent</div>
    <div class="legend-item"><span style="color:#1a5c52;font-size:14px;line-height:1">◆</span>Variance minimale</div>
    <div class="legend-item"><span style="color:#7a1f2e;font-size:14px;line-height:1">●</span>Taux sans risque</div>
    <div class="legend-item" style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
      <div style="width:22px;height:8px;background:linear-gradient(90deg,#c4bdb0,#3466a0,#1a5c52);border-radius:2px;flex-shrink:0"></div>Ratio de Sharpe
    </div>`;
}

function renderCML() {
  const r = appState.results;
  document.getElementById('cmlCard').style.display = 'block';
  const exp = appState.cmlExposure;
  const mixRet = (1-exp)*appState.rf + exp*r.tangent_stats.ret;
  const mixVol = Math.abs(exp)*r.tangent_stats.vol;
  updateCMLControls(exp, mixRet, mixVol);
  const xT=r.tangent_stats.vol*100, xMax=r.tangent_stats.vol*2.2*100;
  const slope=(r.tangent_stats.ret-appState.rf)/r.tangent_stats.vol;
  const xSafe=Array.from({length:50},(_,i)=>i/49*xT);
  const ySafe=xSafe.map(x=>(appState.rf+slope*x/100)*100);
  const xLev=Array.from({length:50},(_,i)=>xT+i/49*(xMax-xT));
  const yLev=xLev.map(x=>(appState.rf+slope*x/100)*100);
  const traces=[
    {x:r.ef_vols.map(v=>v*100),y:r.ef_rets.map(v=>v*100),mode:'lines',type:'scatter',line:{color:'rgba(30,58,95,0.2)',width:1.5},hoverinfo:'skip'},
    {x:xSafe,y:ySafe,mode:'lines',type:'scatter',line:{color:'#1a5c52',width:2.5},hovertemplate:'Vol. : %{x:.2f} %<br>Rend. : %{y:.2f} %<extra>CML sans levier</extra>'},
    {x:xLev,y:yLev,mode:'lines',type:'scatter',line:{color:'#7a1f2e',width:2.5,dash:'dot'},hovertemplate:'Vol. : %{x:.2f} %<br>Rend. : %{y:.2f} %<extra>CML avec levier</extra>'},
    {x:[r.tangent_stats.vol*100],y:[r.tangent_stats.ret*100],mode:'markers',type:'scatter',marker:{size:14,color:'#c4820a',symbol:'star',line:{color:'white',width:1.5}},hovertemplate:`<b>Portefeuille tangent</b><br>Sharpe : ${r.tangent_stats.sharpe.toFixed(2)}<extra></extra>`},
    {x:[0],y:[appState.rf*100],mode:'markers',type:'scatter',marker:{size:9,color:'#7a1f2e',symbol:'circle',line:{color:'white',width:1.5}}},
    {x:[mixVol*100],y:[mixRet*100],mode:'markers',type:'scatter',marker:{size:18,color:'white',symbol:'circle',line:{color:exp>1?'#7a1f2e':'#1a5c52',width:3}},hovertemplate:`<b>Votre portefeuille</b><br>Rend. : ${(mixRet*100).toFixed(2)} %<br>Vol. : ${(mixVol*100).toFixed(2)} %<br>Exposition : ${(exp*100).toFixed(0)} %<extra></extra>`},
  ];
  const layout=plotLayout(); layout.dragmode=false;
  Plotly.react('cmlChart', traces, layout, TOOLBAR);
  document.getElementById('cmlLegend').innerHTML=`
    <div class="legend-title">Légende</div>
    <div class="legend-item"><div class="legend-line" style="background:#1a5c52"></div>CML — sans levier</div>
    <div class="legend-item"><div class="legend-line-dashed" style="color:#7a1f2e;width:22px"></div>CML — avec levier</div>
    <div class="legend-item"><span style="color:#c4820a;font-size:14px">★</span>Portefeuille tangent</div>
    <div class="legend-item"><span style="color:#7a1f2e;font-size:14px">●</span>Taux sans risque</div>
    <div class="legend-item" style="margin-top:4px"><div style="width:16px;height:16px;border-radius:50%;border:3px solid #1a5c52;background:white;flex-shrink:0"></div>Votre portefeuille</div>`;
  setupDraggablePoint();
  renderCMLAlloc();
}

function updateCMLControls(exp, mixRet, mixVol) {
  const mixSharpe = mixVol>0?(mixRet-appState.rf)/mixVol:0;
  const retInp = document.getElementById('mixRetInp');
  const volInp = document.getElementById('mixVolInp');
  if(retInp) { retInp.textContent=(mixRet*100).toFixed(2); retInp.style.color=mixRet>=0?'var(--teal)':'var(--rose)'; }
  if(volInp) volInp.textContent=(mixVol*100).toFixed(2);
  document.getElementById('mixSharpe').textContent=mixSharpe.toFixed(2);
  updateCMLBarLabels(exp);
}

function updateCMLBarLabels(exp) {
  if(exp<=1){
    const rfPct=(1-exp)*100, tPct=exp*100;
    document.getElementById('mixBarRf').style.width=rfPct+'%';
    document.getElementById('mixBarTangent').style.width=tPct+'%';
    document.getElementById('mixBarLev').style.display='none';
    document.getElementById('leverageLabel').style.display='none';
    document.getElementById('mixRfPct').textContent=rfPct.toFixed(0)+' %';
    document.getElementById('mixTangentPct').textContent=tPct.toFixed(0)+' %';
  } else {
    const leveragePct=(exp-1)*100, totalPct=exp*100;
    const tShare=(100/totalPct)*100, lShare=(leveragePct/totalPct)*100;
    document.getElementById('mixBarRf').style.width='0%';
    document.getElementById('mixBarTangent').style.width=tShare.toFixed(1)+'%';
    document.getElementById('mixBarLev').style.width=lShare.toFixed(1)+'%';
    document.getElementById('mixBarLev').style.display='block';
    document.getElementById('leverageLabel').style.display='inline';
    document.getElementById('mixRfPct').textContent='0 %';
    document.getElementById('mixTangentPct').textContent=(exp*100).toFixed(0)+' %';
    document.getElementById('mixLeveragePct').textContent=leveragePct.toFixed(0)+' %';
  }
}

let isDragging=false;
function setupDraggablePoint() {
  const chartDiv=document.getElementById('cmlChart');
  if(chartDiv._draggableSetup) return;
  chartDiv._draggableSetup=true;
  chartDiv.addEventListener('mousedown',e=>{const c=getPlotCoords(e.clientX,e.clientY);if(!c)return;isDragging=true;snapToCML(c.x);e.preventDefault();});
  document.addEventListener('mousemove',e=>{if(!isDragging)return;const c=getPlotCoords(e.clientX,e.clientY);if(c)snapToCML(c.x);e.preventDefault();});
  document.addEventListener('mouseup',()=>{isDragging=false;});
  chartDiv.addEventListener('touchstart',e=>{const t=e.touches[0];const c=getPlotCoords(t.clientX,t.clientY);if(!c)return;isDragging=true;snapToCML(c.x);e.preventDefault();},{passive:false});
  document.addEventListener('touchmove',e=>{if(!isDragging)return;const t=e.touches[0];const c=getPlotCoords(t.clientX,t.clientY);if(c)snapToCML(c.x);e.preventDefault();},{passive:false});
  document.addEventListener('touchend',()=>{isDragging=false;});
  chartDiv.style.cursor='crosshair';
}

function getPlotCoords(clientX,clientY){
  const chartDiv=document.getElementById('cmlChart');
  const fl=chartDiv._fullLayout;if(!fl)return null;
  const rect=chartDiv.getBoundingClientRect();
  const l=fl.margin.l+rect.left,t=fl.margin.t+rect.top;
  const w=fl.xaxis._length,h=fl.yaxis._length;
  const px=clientX-l,py=clientY-t;
  if(px<0||px>w||py<0||py>h)return null;
  return{x:fl.xaxis.range[0]+(px/w)*(fl.xaxis.range[1]-fl.xaxis.range[0]),y:fl.yaxis.range[1]+(py/h)*(fl.yaxis.range[0]-fl.yaxis.range[1])};
}

function snapToCML(xVol_pct){
  const r=appState.results;if(!r)return;
  const maxVol=r.tangent_stats.vol*2.2;
  const clampedVol=Math.max(0,Math.min(xVol_pct/100,maxVol));
  const exp=clampedVol/r.tangent_stats.vol;
  appState.cmlExposure=exp;
  const mixRet=(1-exp)*appState.rf+exp*r.tangent_stats.ret;
  const mixVol=Math.abs(exp)*r.tangent_stats.vol;
  updateCMLControls(exp,mixRet,mixVol);
  Plotly.restyle('cmlChart',{x:[[mixVol*100]],y:[[mixRet*100]],'marker.line.color':[exp>1?'#7a1f2e':'#1a5c52']},[5]);
  renderCMLAlloc();
}

let _cmlStepTimer=null, _cmlCurrentVal={ret:null,vol:null};
function startCMLStep(field,delta){
  const r=appState.results;if(!r)return;
  const span=document.getElementById(field==='ret'?'mixRetInp':'mixVolInp');
  let cur=parseFloat(span.textContent);
  if(isNaN(cur)) cur=field==='ret'?r.tangent_stats.ret*100:r.tangent_stats.vol*100;
  _cmlCurrentVal[field]=cur;
  _cmlCurrentVal[field]+=delta;
  applyCMLEditDirect(field,_cmlCurrentVal[field]);
  let delay=300,count=0;
  function repeat(){_cmlCurrentVal[field]+=delta;applyCMLEditDirect(field,_cmlCurrentVal[field]);count++;delay=count<5?180:count<15?80:30;_cmlStepTimer=setTimeout(repeat,delay);}
  _cmlStepTimer=setTimeout(repeat,delay);
}
function stopCMLStep(){clearTimeout(_cmlStepTimer);_cmlStepTimer=null;}

let _applyingCML=false;
function applyCMLEditDirect(field,val){
  if(_applyingCML)return;
  const r=appState.results;if(!r||isNaN(val))return;
  const maxVol=r.tangent_stats.vol*2.2;
  let exp;
  if(field==='vol'){exp=Math.max(0,Math.min(val/100,maxVol))/r.tangent_stats.vol;}
  else{const denom=r.tangent_stats.ret-appState.rf;if(Math.abs(denom)<1e-9)return;exp=Math.max(0,Math.min((val/100-appState.rf)/denom,2.2));}
  appState.cmlExposure=exp;
  const mixRet=(1-exp)*appState.rf+exp*r.tangent_stats.ret;
  const mixVol=Math.abs(exp)*r.tangent_stats.vol;
  _applyingCML=true;updateCMLControls(exp,mixRet,mixVol);_applyingCML=false;
  Plotly.restyle('cmlChart',{x:[[mixVol*100]],y:[[mixRet*100]],'marker.line.color':[exp>1?'#7a1f2e':'#1a5c52']},[5]);
  renderCMLAlloc();
}

function renderCMLAlloc(){
  const r=appState.results;const exp=appState.cmlExposure;
  const alloc=r.tangent_w.map((w,i)=>({name:r.allNames[i],ticker:r.available[i],wT:w,wTot:w*exp}))
    .sort((a,b)=>b.wTot-a.wTot).filter(a=>a.wT>0.005);
  const rfPart=Math.max(0,(1-exp)*100);
  const levPart=Math.max(0,(exp-1)*100);
  const hasRf=rfPart>0.05,hasLev=levPart>0.05;
  let html=`<table class="alloc-table"><thead><tr><th>Actif</th><th style="text-align:right">Poids tangent</th><th style="text-align:right">Exposition totale</th></tr></thead><tbody>`;
  if(hasRf) html+=`<tr><td><strong>Trésorerie</strong><br><span style="color:var(--muted2);font-size:0.65rem">Cash / Rf</span></td><td style="text-align:right;color:var(--teal)">—</td><td style="text-align:right;color:var(--teal)">${rfPart.toFixed(1)} %</td></tr>`;
  for(const a of alloc) html+=`<tr><td><strong>${a.name}</strong><br><span style="color:var(--muted2);font-size:0.65rem">${a.ticker}</span></td><td style="text-align:right;color:var(--amber)">${(a.wT*100).toFixed(1)} %</td><td style="text-align:right;color:var(--blue)">${(a.wTot*100).toFixed(1)} %</td></tr>`;
  if(hasLev) html+=`<tr><td><strong>Emprunt</strong><br><span style="color:var(--muted2);font-size:0.65rem">Levier financier</span></td><td style="text-align:right;color:var(--rose)">—</td><td style="text-align:right;color:var(--rose)">−${levPart.toFixed(1)} %</td></tr>`;
  html+=`<tr style="border-top:1px solid var(--border);font-weight:600"><td>Total</td><td style="text-align:right;color:var(--muted)">${(exp<=1?exp*100:100).toFixed(0)} %</td><td style="text-align:right;color:var(--ink)">${(exp*100).toFixed(0)} %</td></tr>`;
  document.getElementById('cmlAllocTable').innerHTML=html+'</tbody></table>';
  const pieLabels=alloc.map(a=>a.name),pieValues=alloc.map(a=>Math.abs(a.wTot)*100),pieColors=alloc.map((_,i)=>`hsl(${200+i*22},40%,${45+i%3*8}%)`);
  if(hasRf){pieLabels.unshift('Trésorerie');pieValues.unshift(rfPart);pieColors.unshift('#1a5c52');}
  if(hasLev){pieLabels.push('Emprunt');pieValues.push(levPart);pieColors.push('#7a1f2e');}
  Plotly.react('cmlPieChart',[{type:'pie',labels:pieLabels,values:pieValues,hole:0.42,marker:{colors:pieColors,line:{color:'white',width:1}},textinfo:'percent',hovertemplate:'<b>%{label}</b><br>%{value:.1f} %<extra></extra>',textfont:{color:'white',size:10}}],
    {paper_bgcolor:'transparent',plot_bgcolor:'transparent',showlegend:false,margin:{l:10,r:10,t:10,b:10},font:{color:'#3d3830',family:'DM Sans, sans-serif'}},{responsive:true,displayModeBar:false});
}

// ── Risk levels ───────────────────────────────────────────────────────────────
const RISK_LEVELS=[
  {label:'Défensif',frac:0.00,qual:'Capital préservé en priorité. Convient à un horizon court ou une faible tolérance aux pertes.',math:"Portefeuille à variance minimale : w* = arg min w'Σw sous Σwᵢ=1, wᵢ≥0."},
  {label:'Modéré',frac:0.25,qual:'Légère prise de risque pour améliorer le rendement. Bon équilibre pour un horizon moyen terme.',math:'Vol cible = σ_min + 25% × (σ_tangent − σ_min).'},
  {label:'Équilibré',frac:0.50,qual:'Compromis rendement/risque centré. Adapté à un investisseur long terme.',math:'Vol cible = σ_min + 50% × (σ_tangent − σ_min).'},
  {label:'Dynamique',frac:0.75,qual:'Priorité au rendement avec un risque élevé assumé. Horizon long terme.',math:'Vol cible = σ_min + 75% × (σ_tangent − σ_min).'},
  {label:'Agressif',frac:1.00,qual:'Maximisation du rendement attendu. Concentration maximale sur le meilleur actif.',math:"Portefeuille tangent exact : w* = arg max (μ-rf)/σ."},
];

function renderRiskLevels(){
  document.getElementById('riskCard').style.display='block';
  const tabs=document.getElementById('riskTabs'); tabs.innerHTML='';
  RISK_LEVELS.forEach((lvl,i)=>{
    const wrap=document.createElement('div'); wrap.style.cssText='display:inline-flex;align-items:center;gap:0';
    const btn=document.createElement('button'); btn.className='risk-tab'+(i===0?' active':''); btn.textContent=lvl.label;
    btn.onclick=()=>{document.querySelectorAll('.risk-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderRiskContent(i);};
    const tipWrap=document.createElement('span'); tipWrap.className='risk-tooltip-wrap';
    tipWrap.innerHTML=`<span class="risk-help-btn" tabindex="0">?</span><div class="risk-tooltip-box"><strong>${lvl.label}</strong>${lvl.qual}<div class="tooltip-math">${lvl.math}</div></div>`;
    wrap.appendChild(btn); wrap.appendChild(tipWrap); tabs.appendChild(wrap);
  });
  const customBtn=document.createElement('button'); customBtn.className='risk-tab custom'; customBtn.textContent='Personnalisé';
  customBtn.onclick=()=>{document.querySelectorAll('.risk-tab').forEach(b=>b.classList.remove('active'));customBtn.classList.add('active');renderCustomRisk();};
  tabs.appendChild(customBtn);
  renderRiskContent(0);
}

function renderRiskAlloc(w,stats,containerSel,pieDivId){
  const r=appState.results;
  const alloc=r.allNames.map((name,i)=>({name,ticker:r.available[i],w:w[i]})).sort((a,b)=>b.w-a.w).filter(a=>a.w>0.005);
  document.getElementById(containerSel).innerHTML=`
    <div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px">
        <div class="kpi-card teal" style="padding:12px"><div class="kpi-label">Rendement</div><div class="kpi-value teal" style="font-size:1.2rem">${(stats.ret*100).toFixed(2)} %</div></div>
        <div class="kpi-card amber" style="padding:12px"><div class="kpi-label">Volatilité</div><div class="kpi-value amber" style="font-size:1.2rem">${(stats.vol*100).toFixed(2)} %</div></div>
        <div class="kpi-card blue" style="padding:12px"><div class="kpi-label">Ratio de Sharpe</div><div class="kpi-value blue" style="font-size:1.2rem">${stats.sharpe.toFixed(2)}</div></div>
        <div class="kpi-card rose" style="padding:12px"><div class="kpi-label">Actifs</div><div class="kpi-value rose" style="font-size:1.2rem">${alloc.length}</div></div>
      </div>
      <table class="alloc-table"><thead><tr><th>Actif</th><th>Poids</th><th style="width:80px"></th></tr></thead>
      <tbody>${alloc.map(a=>`<tr><td><strong>${a.name}</strong><br><span style="color:var(--muted2);font-size:0.65rem">${a.ticker}</span></td><td style="color:var(--amber)">${(a.w*100).toFixed(1)} %</td><td><div class="alloc-bar-bg"><div class="alloc-bar-fill" style="width:${Math.min(100,a.w*100)}%"></div></div></td></tr>`).join('')}</tbody></table>
    </div>
    <div id="${pieDivId}" style="height:300px"></div>`;
  const colors=alloc.map((_,i)=>`hsl(${200+i*22},40%,${45+i%3*8}%)`);
  Plotly.react(pieDivId,[{type:'pie',labels:alloc.map(a=>a.name),values:alloc.map(a=>a.w*100),hole:0.42,marker:{colors,line:{color:'white',width:1}},textinfo:'percent',hovertemplate:'<b>%{label}</b><br>%{value:.1f} %<extra></extra>',textfont:{color:'white',size:10}}],
    {paper_bgcolor:'transparent',plot_bgcolor:'transparent',showlegend:false,margin:{l:10,r:10,t:10,b:10},font:{color:'#3d3830',family:'DM Sans, sans-serif'}},{responsive:true,displayModeBar:false});
}

function renderRiskContent(idx){
  const r=appState.results;const lvl=RISK_LEVELS[idx];
  let w,stats;
  if(lvl.frac===1.00){w=r.tangent_w;stats=r.tangent_stats;}
  else if(lvl.frac===0.00){w=r.min_var_w;stats=r.min_var_stats;}
  else {
    const targetVol=r.min_var_stats.vol+lvl.frac*(r.tangent_stats.vol-r.min_var_stats.vol);
    const efIdx=r.ef_vols.reduce((best,v,i)=>Math.abs(v-targetVol)<Math.abs(r.ef_vols[best]-targetVol)?i:best,0);
    w=r.ef_weights[efIdx];
    stats=portfolioStatsLocal(w,r.mean_rets,r.cov_matrix,appState.rf);
  }
  renderRiskAlloc(w,stats,'riskContent','riskPieDiv');
}

function renderCustomRisk(){
  const r=appState.results;const defStats=r.tangent_stats;
  document.getElementById('riskContent').innerHTML=`
    <div>
      <div style="font-size:0.72rem;color:var(--muted);margin-bottom:14px;font-style:italic">Cliquez sur une valeur pour la modifier. Les autres s'ajusteront automatiquement.</div>
      <div class="custom-inputs">
        <div class="custom-kpi-card teal" onclick="startCustomEdit('ret')">
          <div class="kpi-label">Rendement souhaité</div>
          <div class="kpi-value teal" style="font-size:1.2rem">
            <input class="custom-input-field" id="inp-ret" type="number" step="0.01" placeholder="${(defStats.ret*100).toFixed(2)}" style="color:var(--teal)" oninput="solveCustom('ret')"/>
            <span style="font-size:0.85rem;margin-left:2px">%</span>
          </div>
        </div>
        <div class="custom-kpi-card amber" onclick="startCustomEdit('vol')">
          <div class="kpi-label">Volatilité souhaitée</div>
          <div class="kpi-value amber" style="font-size:1.2rem">
            <input class="custom-input-field" id="inp-vol" type="number" step="0.01" placeholder="${(defStats.vol*100).toFixed(2)}" style="color:var(--amber)" oninput="solveCustom('vol')"/>
            <span style="font-size:0.85rem;margin-left:2px">%</span>
          </div>
        </div>
        <div class="custom-kpi-card blue" onclick="startCustomEdit('sharpe')">
          <div class="kpi-label">Ratio de Sharpe</div>
          <div class="kpi-value blue" style="font-size:1.2rem">
            <input class="custom-input-field" id="inp-sharpe" type="number" step="0.01" placeholder="${defStats.sharpe.toFixed(2)}" style="color:var(--blue)" oninput="solveCustom('sharpe')"/>
          </div>
        </div>
        <div class="kpi-card rose" style="padding:12px;cursor:default"><div class="kpi-label">Actifs optimaux</div><div class="kpi-value rose" style="font-size:1.2rem" id="cc-nassets">—</div></div>
      </div>
      <div id="customAllocLeft"></div>
    </div>
    <div id="customPie" style="height:300px;"></div>`;
}

function startCustomEdit(field){
  ['ret','vol','sharpe'].forEach(f=>{const card=document.querySelector(`[onclick="startCustomEdit('${f}')"]`);if(card)card.classList.toggle('editing',f===field);});
  const inp=document.getElementById('inp-'+field);if(inp){inp.focus();inp.select();}
}

let _solvingCustom=false;
function solveCustom(field){
  if(_solvingCustom)return;
  const r=appState.results;
  const rawVal=parseFloat(document.getElementById('inp-'+field).value);
  if(isNaN(rawVal))return;
  const efVols=r.ef_vols,efRets=r.ef_rets,efWeights=r.ef_weights;
  const efSharpes=efVols.map((v,i)=>v>0?(efRets[i]-appState.rf)/v:0);
  const maxVol=Math.max(...efVols),minVol=Math.min(...efVols),maxRet=Math.max(...efRets),minRet=Math.min(...efRets),maxSharpe=Math.max(...efSharpes),minSharpe=Math.min(...efSharpes);
  let clampedVal=rawVal,clamped=false;
  if(field==='vol'){if(rawVal>maxVol*100){clampedVal=maxVol*100;clamped=true;}if(rawVal<minVol*100){clampedVal=minVol*100;clamped=true;}}
  else if(field==='ret'){if(rawVal>maxRet*100){clampedVal=maxRet*100;clamped=true;}if(rawVal<minRet*100){clampedVal=minRet*100;clamped=true;}}
  else if(field==='sharpe'){if(rawVal>maxSharpe){clampedVal=maxSharpe;clamped=true;}if(rawVal<minSharpe){clampedVal=minSharpe;clamped=true;}}
  if(clamped){const inp=document.getElementById('inp-'+field);inp.value=clampedVal.toFixed(2);inp.style.color='var(--rose)';setTimeout(()=>{inp.style.color=field==='vol'?'var(--amber)':field==='ret'?'var(--teal)':'var(--blue)';},900);}
  const wMV=r.min_var_w,wT=r.tangent_w;
  const t=field==='sharpe'?clampedVal:clampedVal/100;
  const evalAlpha=a=>{const wk=wMV.map((v,i)=>(1-a)*v+a*wT[i]);return portfolioStatsLocal(wk,r.mean_rets,r.cov_matrix,appState.rf);};
  const metric=s=>field==='vol'?s.vol:field==='ret'?s.ret:s.sharpe;
  const f=a=>metric(evalAlpha(a))-t;
  const f0=f(0),f1=f(1);
  let alpha,w,stats;
  const nearTangent=(field==='vol'&&Math.abs(clampedVal-r.tangent_stats.vol*100)<0.15)||(field==='ret'&&Math.abs(clampedVal-r.tangent_stats.ret*100)<0.15)||(field==='sharpe'&&Math.abs(clampedVal-r.tangent_stats.sharpe)<0.15);
  const nearMinVar=(field==='vol'&&Math.abs(clampedVal-r.min_var_stats.vol*100)<0.15)||(field==='ret'&&Math.abs(clampedVal-r.min_var_stats.ret*100)<0.15)||(field==='sharpe'&&Math.abs(clampedVal-r.min_var_stats.sharpe)<0.15);
  if(nearTangent){w=r.tangent_w;stats=r.tangent_stats;}
  else if(nearMinVar){w=r.min_var_w;stats=r.min_var_stats;}
  else{
    if(f0*f1>0){alpha=Math.abs(f0)<Math.abs(f1)?0:1;}
    else{let lo=0,hi=1;for(let i=0;i<64;i++){const mid=(lo+hi)/2;if(f(mid)*f0<=0)hi=mid;else lo=mid;}alpha=(lo+hi)/2;}
    alpha=Math.max(0,Math.min(1,alpha));
    const wInterp=wMV.map((v,i)=>(1-alpha)*v+alpha*wT[i]);
    const wSum=wInterp.reduce((s,v)=>s+Math.max(0,v),0);
    w=wInterp.map(v=>Math.max(0,v)/wSum);
    stats=portfolioStatsLocal(w,r.mean_rets,r.cov_matrix,appState.rf);
  }
  _solvingCustom=true;
  if(field!=='ret') document.getElementById('inp-ret').value=(stats.ret*100).toFixed(2);
  if(field!=='vol') document.getElementById('inp-vol').value=(stats.vol*100).toFixed(2);
  if(field!=='sharpe') document.getElementById('inp-sharpe').value=stats.sharpe.toFixed(2);
  _solvingCustom=false;
  const alloc=r.allNames.map((name,i)=>({name,ticker:r.available[i],w:w[i]})).filter(a=>a.w>0.005);
  document.getElementById('cc-nassets').textContent=alloc.length;
  const sortedAlloc=[...alloc].sort((a,b)=>b.w-a.w);
  document.getElementById('customAllocLeft').innerHTML=`<table class="alloc-table"><thead><tr><th>Actif</th><th>Poids</th><th style="width:80px"></th></tr></thead><tbody>${sortedAlloc.map(a=>`<tr><td><strong>${a.name}</strong><br><span style="color:var(--muted2);font-size:0.65rem">${a.ticker}</span></td><td style="color:var(--amber)">${(a.w*100).toFixed(1)} %</td><td><div class="alloc-bar-bg"><div class="alloc-bar-fill" style="width:${Math.min(100,a.w*100)}%"></div></div></td></tr>`).join('')}</tbody></table>`;
  const colors=sortedAlloc.map((_,i)=>`hsl(${200+i*22},40%,${45+i%3*8}%)`);
  Plotly.react('customPie',[{type:'pie',labels:sortedAlloc.map(a=>a.name),values:sortedAlloc.map(a=>a.w*100),hole:0.42,marker:{colors,line:{color:'white',width:1}},textinfo:'percent',hovertemplate:'<b>%{label}</b><br>%{value:.1f} %<extra></extra>',textfont:{color:'white',size:10}}],
    {paper_bgcolor:'transparent',plot_bgcolor:'transparent',showlegend:false,margin:{l:10,r:10,t:10,b:10},font:{color:'#3d3830',family:'DM Sans, sans-serif'}},{responsive:true,displayModeBar:false});
}

// ── ETF Equivalent ────────────────────────────────────────────────────────────
async function computeETFEquivalent(){
  const r=appState.results;if(!r)return;
  const activeTab=document.querySelector('.risk-tab.active');
  const isCustom=activeTab&&activeTab.textContent.trim()==='Personnalisé';
  let targetRet,targetVol,targetSharpe;
  if(isCustom){
    targetRet=parseFloat(document.getElementById('inp-ret').value)/100;
    targetVol=parseFloat(document.getElementById('inp-vol').value)/100;
    targetSharpe=parseFloat(document.getElementById('inp-sharpe').value);
  } else {
    const kpis=document.querySelectorAll('#riskContent .kpi-value');
    targetRet=parseFloat(kpis[0]?.textContent)/100||r.tangent_stats.ret;
    targetVol=parseFloat(kpis[1]?.textContent)/100||r.tangent_stats.vol;
    targetSharpe=parseFloat(kpis[2]?.textContent)||r.tangent_stats.sharpe;
  }
  const resultDiv=document.getElementById('etfEquivResult');
  resultDiv.style.display='block';
  resultDiv.innerHTML='<div class="etf-loading">Calcul en cours sur le serveur…</div>';
  document.getElementById('etfEquivBtn').disabled=true;
  try{
    const resp=await fetch(`${API_URL}/etf-equivalent`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({target_ret:targetRet,target_vol:targetVol,target_sharpe:targetSharpe,period:appState.period,rf:appState.rf})});
    if(!resp.ok) throw new Error((await resp.json().catch(()=>({detail:resp.statusText}))).detail);
    const data=await resp.json();
    renderETFResults(data.combos,{ret:targetRet,vol:targetVol,sharpe:targetSharpe});
  }catch(e){resultDiv.innerHTML=`<div class="etf-loading" style="color:var(--rose)">Erreur : ${e.message}</div>`;}
  finally{document.getElementById('etfEquivBtn').disabled=false;}
}

function renderETFResults(combos,target){
  const resultDiv=document.getElementById('etfEquivResult');
  let html=`<div style="margin-bottom:12px"><div style="font-size:0.65rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-bottom:4px">Portefeuille cible</div><div style="display:flex;gap:10px;flex-wrap:wrap"><span class="etf-metric">Rendement : <strong>${(target.ret*100).toFixed(2)} %</strong></span><span class="etf-metric">Volatilité : <strong>${(target.vol*100).toFixed(2)} %</strong></span><span class="etf-metric">Sharpe : <strong>${target.sharpe.toFixed(2)}</strong></span></div></div><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">`;
  for(const combo of combos){
    const dVol=Math.abs(combo.stats.vol-target.vol)/(target.vol+1e-6);
    const dRet=Math.abs(combo.stats.ret-target.ret)/(Math.abs(target.ret)+0.01);
    const rmse=Math.sqrt(0.6*dVol*dVol+0.4*dRet*dRet);
    const matchPct=Math.max(0,Math.min(100,100*Math.exp(-2.5*rmse)));
    const matchColor=matchPct>70?'var(--teal)':matchPct>40?'var(--amber)':'var(--rose)';
    const dRet2=((combo.stats.ret-target.ret)*100).toFixed(2);
    const dVol2=((combo.stats.vol-target.vol)*100).toFixed(2);
    html+=`<div class="etf-card"><div class="etf-card-header">${combo.size} ETF${combo.size>1?'s':''}</div><div style="margin-bottom:10px">${combo.etfs.map(e=>`<div style="display:flex;justify-content:space-between;align-items:baseline;padding:5px 0;border-bottom:1px solid var(--border)"><div><strong style="font-size:0.8rem">${e.ticker}</strong><div style="font-size:0.62rem;color:var(--muted2)">${e.name}</div><div style="font-size:0.6rem;color:var(--muted);font-style:italic">${e.cat}</div></div><div style="text-align:right"><div style="color:var(--amber);font-weight:700;font-size:0.85rem">${(e.w*100).toFixed(1)} %</div><div class="alloc-bar-bg" style="width:50px;margin-top:3px"><div class="alloc-bar-fill" style="width:${Math.min(100,e.w*100)}%"></div></div></div></div>`).join('')}</div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-bottom:8px"><div class="etf-metric">Rend.<br><strong style="color:var(--teal)">${(combo.stats.ret*100).toFixed(2)} %</strong><br><span style="font-size:0.6rem;color:var(--muted2)">${dRet2>0?'+':''}${dRet2}%</span></div><div class="etf-metric">Vol.<br><strong style="color:var(--amber)">${(combo.stats.vol*100).toFixed(2)} %</strong><br><span style="font-size:0.6rem;color:var(--muted2)">${dVol2>0?'+':''}${dVol2}%</span></div><div class="etf-metric">Sharpe<br><strong style="color:var(--blue)">${combo.stats.sharpe.toFixed(2)}</strong></div></div><div class="etf-metric" style="margin-bottom:4px">Score d'approximation : <strong style="color:${matchColor}">${matchPct.toFixed(0)} %</strong></div><div class="etf-match-bar"><div class="etf-match-fill" style="width:${matchPct.toFixed(0)}%;background:${matchColor}"></div></div></div>`;
  }
  resultDiv.innerHTML=html+'</div>';
}

// ── Performance ───────────────────────────────────────────────────────────────
function renderPerf(){
  const r=appState.results;
  document.getElementById('perfCard').style.display='block';
  document.getElementById('corrCard').style.display='block';
  const nA=r.n;
  const mktRets=r.rets_aligned[0].map((_,t)=>r.rets_aligned.reduce((s,arr)=>s+arr[t],0)/nA);
  const mktVar=mktRets.reduce((s,v,t,a)=>{const m=a.reduce((x,y)=>x+y,0)/a.length;return s+(v-m)*(v-m);},0)/(mktRets.length-1);
  const rows=r.allNames.map((name,i)=>{
    const assetRets=r.rets_aligned[i];
    const mA=assetRets.reduce((s,v)=>s+v,0)/assetRets.length;
    const mM=mktRets.reduce((s,v)=>s+v,0)/mktRets.length;
    const covAM=assetRets.reduce((s,v,t)=>s+(v-mA)*(mktRets[t]-mM),0)/(assetRets.length-1);
    const beta=mktVar>0?covAM/mktVar:1;
    return{name,ticker:r.available[i],ret:r.ann_mean_rets[i],vol:r.ann_stds[i],sharpe:(r.ann_mean_rets[i]-appState.rf)/r.ann_stds[i],beta};
  }).sort((a,b)=>b.sharpe-a.sharpe);
  let html=`<thead><tr><th>Actif</th><th style="text-align:right">Rendement annualisé</th><th style="text-align:right">Volatilité annualisée</th><th style="text-align:right">Ratio de Sharpe</th><th style="text-align:right">Bêta</th></tr></thead><tbody>`;
  for(const row of rows){const betaColor=row.beta>1.2?'var(--rose)':row.beta<0.8?'var(--teal)':'var(--ink2)';html+=`<tr><td><strong>${row.name}</strong> <span style="color:var(--muted2);font-size:0.7rem">${row.ticker}</span></td><td class="${row.ret>=0?'positive':'negative'}">${(row.ret*100).toFixed(2)} %</td><td style="color:var(--amber)">${(row.vol*100).toFixed(2)} %</td><td class="${row.sharpe>=1?'positive':row.sharpe<0?'negative':''}">${row.sharpe.toFixed(2)}</td><td style="color:${betaColor};font-weight:500">${row.beta.toFixed(2)}</td></tr>`;}
  document.getElementById('perfTable').innerHTML=html+'</tbody>';
  renderCorrMatrix();
}

function renderCorrMatrix(){
  const r=appState.results;const n=r.n;
  const corr=Array.from({length:n},(_,i)=>Array.from({length:n},(_,j)=>{
    const si=r.ann_stds[i]/Math.sqrt(52),sj=r.ann_stds[j]/Math.sqrt(52);
    return Math.max(-1,Math.min(1,r.cov_matrix[i][j]/(si*sj+1e-12)));
  }));
  function corrColor(v){
    if(v>=0){const t=v;return`rgb(${Math.round(255+t*(30-255))},${Math.round(255+t*(58-255))},${Math.round(255+t*(95-255))})`;}
    const t=-v;return`rgb(${Math.round(255+t*(176-255))},${Math.round(255+t*(48-255))},${Math.round(255+t*(69-255))})`;
  }
  const names=r.allNames;
  let html=`<table class="corr-table"><tr><td></td>${names.map(n=>`<td class="corr-label" style="writing-mode:vertical-rl;transform:rotate(180deg);max-height:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${n}</td>`).join('')}</tr>`;
  for(let i=0;i<n;i++){
    html+=`<tr><td class="corr-label" style="white-space:nowrap;max-width:120px;overflow:hidden;text-overflow:ellipsis">${names[i]}</td>`;
    for(let j=0;j<n;j++){
      const v=corr[i][j];const bg=corrColor(v);
      const textColor=Math.abs(v)>0.5?'white':'#3d3830';
      html+=`<td><div class="corr-cell" style="background:${bg};color:${textColor}" title="${names[i]} × ${names[j]} : ${v.toFixed(2)}">${v.toFixed(2)}</div></td>`;
    }
    html+='</tr>';
  }
  document.getElementById('corrMatrix').innerHTML=html+'</table>';
}

// ── Contact ───────────────────────────────────────────────────────────────────
function openContact(){
  const u=['armand','villata'].join('.');const d=['icloud','com'].join('.');const addr=u+String.fromCharCode(64)+d;
  const target=document.getElementById('contactMailTarget');target.innerHTML='';
  const a=document.createElement('a');a.className='popup-mail';a.textContent=addr;a.href='mailto:'+addr;target.appendChild(a);
  document.getElementById('contactPopup').classList.add('active');
}
function closeContact(){document.getElementById('contactPopup').classList.remove('active');}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeContact();});

buildSidebar();
</script>
</body>
</html>
